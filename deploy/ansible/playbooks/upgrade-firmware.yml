---
# Upgrade firmware on OpenWrt devices
- name: Firmware upgrade
  hosts: gateways
  gather_facts: false
  vars:
    firmware_url: ""  # Set via -e firmware_url=http://...
    keep_settings: true

  tasks:
    - name: Validate firmware URL
      assert:
        that: firmware_url | length > 0
        fail_msg: "firmware_url is required. Use: -e firmware_url=http://..."

    - name: Download firmware
      raw: cd /tmp && wget -O firmware.bin '{{ firmware_url }}'
      changed_when: true

    - name: Verify firmware
      raw: sysupgrade -T /tmp/firmware.bin
      changed_when: false

    - name: Apply firmware
      raw: sysupgrade {{ '-n' if not keep_settings else '' }} /tmp/firmware.bin
      async: 1
      poll: 0
      changed_when: true

    - name: Wait for device to come back online
      wait_for_connection:
        delay: 60
        timeout: 300
